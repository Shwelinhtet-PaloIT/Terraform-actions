name: 'Trivy Security Scan'
description: 'Run Trivy security scanning with SARIF upload'

inputs:
  enabled:
    description: 'Enable Trivy scanning (true/false)'
    required: true
  
  working-directory:
    description: 'Working directory containing Terraform code'
    required: true
  
  severity:
    description: 'Minimum severity to fail (CRITICAL, HIGH, MEDIUM, LOW)'
    required: true
  
  environment:
    description: 'Target environment for SARIF category naming'
    required: true

outputs:
  outcome:
    description: 'Scan outcome (success/failure/skipped)'
    value: ${{ steps.result.outputs.outcome }}

runs:
  using: 'composite'
  steps:
    - name: Run Trivy security scan
      id: scan
      if: inputs.enabled == 'true'
      continue-on-error: true
      uses: aquasecurity/trivy-action@dc5a429b52fcf669ce959baa2c2dd26090d2a6c4 # v0.32.0
      with:
        scan-type: 'config'
        scan-ref: ${{ inputs.working-directory }}
        format: 'sarif'
        output: 'trivy-results.sarif'
        severity: ${{ inputs.severity }}
    
    - name: Upload Trivy SARIF
      if: inputs.enabled == 'true' && always()
      continue-on-error: true
      uses: github/codeql-action/upload-sarif@7434149006143a4d75b82a2f411ef15b03ccc2d7  # v4.32.2
      with:
        sarif_file: trivy-results.sarif
        category: trivy-${{ inputs.environment }}
        wait-for-processing: true
    
    - name: Set outcome
      id: result
      if: always()
      shell: bash
      run: |
        if [ "${{ inputs.enabled }}" != "true" ]; then
          echo "outcome=skipped" >> $GITHUB_OUTPUT
          echo "⏭️ Trivy: Skipped (disabled)"
        elif [ "${{ steps.scan.outcome }}" == "success" ] && [ -f "trivy-results.sarif" ]; then
          echo "outcome=success" >> $GITHUB_OUTPUT
          echo "✅ Trivy: Passed"
        else
          echo "outcome=failure" >> $GITHUB_OUTPUT
          echo "❌ Trivy: Failed"
          if [ ! -f "trivy-results.sarif" ]; then
            echo "::warning::Trivy SARIF file not generated - scan may have errored"
          fi
          exit 1
        fi
